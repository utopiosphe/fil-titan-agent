<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebSSH</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: row;
    }
    #sidebar {
      width: 250px;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }
    #sidebar h2 {
      margin: 0;
      padding: 1rem;
      font-size: 1.2rem;
      border-bottom: 1px solid #ccc;
    }
    #agentList {
      flex: 1;
      overflow-y: auto;
      margin: 0;
      padding: 0;
      list-style: none;
    }
    #agentList li {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #agentList li:hover {
      background: #f5f5f5;
    }
    #refreshBtn {
      padding: 0.5rem;
      margin: 0.5rem;
      cursor: pointer;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #terminal {
      flex: 1;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Online Agents</h2>
    <ul id="agentList"></ul>
    <button id="refreshBtn">Refresh</button>
  </div>
  <div id="main">
    <div id="terminal"></div>
  </div>

<script>
const term = new Terminal();
term.open(document.getElementById('terminal'));

let socket;
const encoder = new TextEncoder();
const decoder = new TextDecoder("utf-8");
let currentAgentId = null;

// Initialize xterm: only bind once
term.onData(data => {
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(encoder.encode(data));
  }
});

async function connectToAgent(nodeId) {
  if (!nodeId) return;
  if (socket) {
    socket.onmessage = null;
    socket.close();
  }
  currentAgentId = nodeId;

  socket = new WebSocket("ws://" + window.location.host + "/frontend/ws?nodeId=" + nodeId);
  socket.binaryType = "arraybuffer";

  term.clear();
  term.write("Connecting to " + nodeId + "...\r\n");

  socket.onopen = () => {
    term.write("[Connected to " + nodeId + "]\r\n");
  };

  socket.onmessage = e => {
    const text = decoder.decode(e.data);
    term.write(text);
  };

  socket.onclose = () => {
    term.write("\r\n[Disconnected from " + nodeId + "]\r\n");
  };
}

// loadAgents: fetch online agents
async function loadAgents() {
  try {
    const res = await fetch("/agents");
    if (!res.ok) throw new Error("Failed to fetch agents");

    const agents = await res.json();
    renderAgentList(agents);
  } catch (err) {
    console.error("Error loading agents:", err);
    term.write("Error loading agent list\n");
  }
}

function renderAgentList(agents) {
  const listElem = document.getElementById("agentList");
  listElem.innerHTML = "";

  if (!agents.length) {
    const li = document.createElement("li");
    li.textContent = "No available agents";
    listElem.appendChild(li);
    return;
  }

  agents.forEach(id => {
    const li = document.createElement("li");
    li.textContent = id;
    li.onclick = () => {
      connectToAgent(id);
    };
    listElem.appendChild(li);
  });

  // auto-select first if none selected
  if (!currentAgentId && agents.length > 0) {
    connectToAgent(agents[0]);
  } else if (currentAgentId && !agents.includes(currentAgentId)) {
    term.write("\r\n[Previously selected agent disconnected]\r\n");
  }
}

// Refresh button
document.getElementById("refreshBtn").addEventListener("click", loadAgents);

loadAgents();
</script>
</body>
</html>